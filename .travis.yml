language: cpp

os: linux
dist: bionic
apt:
  sources:
    - sourceline: 'ppa:scottaiton/thunderegg-deps'
jobs:
  include:
  - compiler: gcc
    addons:
      sonarcloud:
          organization: "thunderegg"
      apt:
        packages:
          - cmake
          - libfftw3-dev
          - libopenmpi-dev
          - openmpi-bin
          - petsc-dev
          - libblas-dev
          - liblapack-dev
          - libtrilinos-zoltan-dev
    before_script:
        - export BUILD_WRAPPER="build-wrapper-linux-x86-64 --out-dir bw-output"
        - export CXXFLAGS="-ftest-coverage -fno-inline -fno-inline-small-functions -fno-default-inline"
        - export CFLAGS="-fprofile-arcs -ftest-coverage -fno-inline -fno-inline-small-functions -fno-default-inline"
        - export LDFLAGS="-lgcov"
    after_script: 
        - gcovr --exclude-unreachable-branches --exclude-throw-branches -f src/ -b --sonarqube coverage.xml
        - sonar-scanner
  - compiler: gcc
    addons:
      apt:
        packages:
          - cmake
          - libopenmpi-dev
          - openmpi-bin
          - petsc-dev
          - libblas-dev
          - liblapack-dev
          - libtrilinos-zoltan-dev
  - compiler: gcc
    addons:
      apt:
        packages:
          - cmake
          - libfftw3-dev
          - libopenmpi-dev
          - openmpi-bin
          - libblas-dev
          - liblapack-dev
          - libtrilinos-zoltan-dev
before_install:
  - pip install --user cpp-coveralls
  - pip install --user gcovr
  - export CXXFLAGS="-std=c++11"
script:
  - export CXXFLAGS="-g -O0 -Wall -W $CXXFLAGS"
  - export CFLAGS="-g -O0 -Wall -W $CFLAGS"
  - cmake .
  - $BUILD_WRAPPER make
  - ctest -V
after_success:
  - coveralls --include src --exclude src/Thunderegg/Experimental --gcov-options '\-lp'
